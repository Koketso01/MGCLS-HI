{% extends "layout.html" %}
{% block title %}{{ cluster_id }} · MGCLS–H I{% endblock %}

{% block content %}
<div class="container my-4">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="mb-0">“{{ cluster_id }}”</h2>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('index') }}">← Back to Home</a>
  </div>

  <!-- ============ Cluster figure ============ -->
  <div class="card shadow-sm mb-3">
    <div class="card-body p-2">
      <div class="cluster-figure-wrap">
        {% set img_url = fig_url or '' %}
        <img id="cluster-figure"
             src="{{ img_url }}"
             alt="{{ cluster_id }}_Intensity_SNR.png"
             class="img-fluid rounded"
             onerror="handleNoFigure()">

        <div id="cluster-figure-fallback" class="figure-fallback d-none">
          <div class="fallback-text">No cluster figure</div>
        </div>
      </div>
      <small class="text-muted d-block mt-2">Source: S3 Cluster-Figures</small>
    </div>
  </div>

  <!-- ============ Actions ============ -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex flex-wrap gap-2 align-items-center">
      <!-- Cluster bundle -->
      <a class="btn btn-success"
         href="{{ url_for('download_cluster', cluster=cluster_id) }}">
        Download cluster bundle (ZIP)
      </a>
      <button class="btn btn-outline-secondary"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#cliClusterBundle"
              aria-expanded="false"
              aria-controls="cliClusterBundle">
        CLI
      </button>
      <div class="collapse w-100" id="cliClusterBundle">
        <div class="border rounded p-2 bg-light mt-2">
          <div class="small text-muted mb-1">Terminal:</div>
          <pre class="mb-2"><code>wget -O "{{ cluster_id }}_cluster_products.zip" "{{ url_for('download_cluster', cluster=cluster_id, _external=True) }}"</code></pre>
          <pre class="mb-2"><code>curl -L -o "{{ cluster_id }}_cluster_products.zip" "{{ url_for('download_cluster', cluster=cluster_id, _external=True) }}"</code></pre>
        </div>
      </div>

      <!-- All galaxies bundle -->
      <a class="btn btn-primary ms-0 ms-sm-2"
         href="{{ url_for('download_all_galaxies', cluster=cluster_id) }}">
        Download all galaxies (ZIP)
      </a>
      <button class="btn btn-outline-secondary"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#cliAllGalaxies"
              aria-expanded="false"
              aria-controls="cliAllGalaxies">
        CLI
      </button>
      <div class="collapse w-100" id="cliAllGalaxies">
        <div class="border rounded p-2 bg-light mt-2">
          <div class="small text-muted mb-1">Terminal:</div>
          <pre class="mb-2"><code>wget -O "{{ cluster_id }}_all_galaxies.zip" "{{ url_for('download_all_galaxies', cluster=cluster_id, _external=True) }}"</code></pre>
          <pre class="mb-2"><code>curl -L -o "{{ cluster_id }}_all_galaxies.zip" "{{ url_for('download_all_galaxies', cluster=cluster_id, _external=True) }}"</code></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ Galaxy table (ID column removed) ============ -->
  <h5 class="mb-2">Galaxies in “{{ cluster_id }}”</h5>
  <div class="table-responsive">
    <table class="table table-striped table-hover table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th>Galaxy Name</th>
          <th>RA</th>
          <th>DEC</th>
          <th>V<sub>rad</sub></th>
          <th>S<sub>int</sub></th>
          <th>W<sub>20</sub></th>
          <th>W<sub>50</sub></th>
          <th>Download</th>
        </tr>
        <tr class="units-row">
          <th class="text-muted small"></th>
          <th class="text-muted small">HH:MM:SS.S</th>
          <th class="text-muted small">DD:MM:SS.S</th>
          <th class="text-muted small">km/s</th>
          <th class="text-muted small"></th>
          <th class="text-muted small">km/s</th>
          <th class="text-muted small">km/s</th>
          <th class="text-muted small"></th>
        </tr>
      </thead>
      <tbody>
        {% if galaxy_rows and galaxy_rows|length %}
          {% for g in galaxy_rows %}
            {# keep gid for downloads, but don't display it #}
            {% set gid = g.id %}
            {% set gname = g.name or '' %}
            {% set outname = (gname|replace(' ', '_') ~ '_galaxy.zip') if gname else (cluster_id ~ '_id' ~ gid ~ '-galaxy.zip') %}
            <tr>
              <td class="text-nowrap">{{ g.name }}</td>
              <td>{{ g.ra }}</td>
              <td>{{ g.dec }}</td>
              <td>{{ g.vrad }}</td>
              <td>{{ g.sint }}</td>
              <td>{{ g.w20 }}</td>
              <td>{{ g.w50 }}</td>
              <td class="text-nowrap">
                <a class="btn btn-sm btn-success"
                   href="{{ url_for('download_galaxy', cluster=cluster_id, gid=gid) }}">
                  ZIP
                </a>
                <button class="btn btn-sm btn-outline-secondary"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#cliGal{{ loop.index0 }}"
                        aria-expanded="false"
                        aria-controls="cliGal{{ loop.index0 }}">
                  CLI
                </button>
                <div class="collapse mt-2" id="cliGal{{ loop.index0 }}">
                  <div class="border rounded p-2 bg-light">
                    <div class="small text-muted mb-1">Terminal:</div>
                    <pre class="mb-2"><code>wget -O "{{ outname }}" "{{ url_for('download_galaxy', cluster=cluster_id, gid=gid, _external=True) }}"</code></pre>
                    <pre class="mb-2"><code>curl -L -o "{{ outname }}" "{{ url_for('download_galaxy', cluster=cluster_id, gid=gid, _external=True) }}"</code></pre>
                  </div>
                </div>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              No galaxies found for this cluster.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<style>
  /* Subtle styling for the units row */
  .units-row th { font-weight: 400; }

  .cluster-figure-wrap {
    position: relative;
    width: 100%;
    min-height: 240px;
    background: #0f0f13;
    border-radius: .5rem;
    overflow: hidden;
  }
  .cluster-figure-wrap img {
    display: block;
    width: 100%;
    height: auto;
  }
  .figure-fallback {
    position: absolute;
    inset: 0;
    background: #222;
    display: grid;
    place-items: center;
    color: #ddd;
  }
  .figure-fallback .fallback-text {
    font-size: clamp(1.2rem, 3vw, 2.2rem);
    opacity: .9;
  }
  .d-none { display: none !important; }
</style>

<script>
  function handleNoFigure() {
    const img = document.getElementById('cluster-figure');
    if (img) img.classList.add('d-none');
    const fb = document.getElementById('cluster-figure-fallback');
    if (fb) fb.classList.remove('d-none');
  }
</script>
{% endblock %}
